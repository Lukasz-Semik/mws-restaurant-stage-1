let restaurant;var map;const buttonLike=document.getElementById("btn-like");navigator.serviceWorker&&navigator.serviceWorker.register("/sw.js");const initMap=(a,b)=>{if(a)console.error(a);else{const a=new google.maps.Map(document.getElementById("map"),{zoom:16,center:b.latlng,scrollwheel:!1});self.map=a,google.maps.event.addListener(a,"tilesloaded",function(){[].slice.apply(document.querySelectorAll("#map *")).forEach(function(a){a.setAttribute("tabindex","-1")})}),fillBreadcrumb(),DBHelper.mapMarkerForRestaurant(self.restaurant,self.map)}};window.initMap=()=>{fetchRestaurantFromURL((a,b)=>initMap(a,b))},fetchRestaurantFromURL=a=>{if(self.restaurant)return void(a&&a(null,self.restaurant));const b=getParameterByName("id");b?dbPromise.then(function(a){var c=a.transaction("restaurants"),d=c.objectStore("restaurants");return d.get(`restaurant-${b}`)}).then(c=>{c?(self.restaurant=c,fillRestaurantHTML(),a&&a(null,c)):fetch(`http://localhost:1337/restaurants/${b}`).then(a=>a.json()).then(c=>{fetch(`http://localhost:1337/reviews/?restaurant_id=${getParameterByName("id")}`).then(a=>a.json()).then(d=>{c.reviews=d,saveRestaurantInIndexedDb(c,b,a)})})}):(error="No restaurant id in URL",a&&a(error,null))};const saveRestaurantInIndexedDb=(a,b,c)=>dbPromise.then(d=>{const e=d.transaction("restaurants","readwrite"),f=e.objectStore("restaurants");return(f.put(a,`restaurant-${b}`),self.restaurant=a,!a)?void console.error(error):(c&&(c(null,a),fillRestaurantHTML()),e.complete)}),setButtonLikeClass=a=>{"true"===a.is_favorite||!0===a.is_favorite?buttonLike.classList.add("btn-like--is-favourite"):buttonLike.classList.remove("btn-like--is-favourite")};buttonLike.addEventListener("click",()=>{const a=self.restaurant.is_favorite;self.restaurant.is_favorite=!a,setButtonLikeClass(self.restaurant),fetch(`http://localhost:1337/restaurants/${self.restaurant.id}/?is_favorite=${!a}`,{method:"POST"}).then(()=>{saveRestaurantInIndexedDb(self.restaurant,self.restaurant.id)})}),fillRestaurantHTML=(a=self.restaurant)=>{setButtonLikeClass(a);const b=document.getElementById("restaurant-name");b.innerHTML=a.name;const c=document.getElementById("restaurant-address");c.innerHTML=a.address;const d=document.getElementById("restaurant-img");d.src=DBHelper.imageUrlForRestaurant(a,!0),d.alt=`An image from the restaurant ${a.name}`;const e=document.getElementById("restaurant-cuisine");e.innerHTML=a.cuisine_type,a.operating_hours&&fillRestaurantHoursHTML(),fillReviewsHTML()},fillRestaurantHoursHTML=(a=self.restaurant.operating_hours)=>{const b=document.getElementById("restaurant-hours");for(let c in b.className="restaurant-detail__hours",a){const d=document.createElement("tr"),e=document.createElement("td");e.innerHTML=c,d.appendChild(e);const f=document.createElement("td");f.innerHTML=a[c],d.appendChild(f),b.appendChild(d)}},fillReviewsHTML=(a=self.restaurant.reviews)=>{const b=document.getElementById("reviews-container");if(!a){const a=document.createElement("p");return a.innerHTML="No reviews yet!",void b.appendChild(a)}const c=document.getElementById("reviews-list");a.forEach(a=>{c.appendChild(createReviewHTML(a))}),b.appendChild(c)};const prefixZero=a=>10>a?`0${a}`:a;createReviewHTML=a=>{const b=document.createElement("li"),c=document.createElement("p");c.className="restaurant-review__text",c.innerHTML=a.name,b.appendChild(c);const d=document.createElement("p");d.className="restaurant-review__date";let e=new Date(a.updatedAt||a.createdAt);const f=`${e.getFullYear()}-${prefixZero(e.getMonth()+1)}-${prefixZero(e.getDate())}`;d.innerHTML=f,b.appendChild(d);const g=document.createElement("p");g.className="restaurant-review__rating",g.innerHTML=`Rating: ${a.rating}`,b.appendChild(g);const h=document.createElement("p");return h.className="restaurant-review__comment",h.innerHTML=a.comments,b.appendChild(h),b},fillBreadcrumb=(a=self.restaurant)=>{const b=document.getElementById("breadcrumb");b.setAttribute("role","menubar");const c=document.createElement("li");c.innerHTML=a.name,b.appendChild(c)},getParameterByName=(a,b)=>{b||(b=window.location.href),a=a.replace(/[\[\]]/g,"\\$&");const c=new RegExp(`[?&]${a}(=([^&#]*)|&|#|$)`),d=c.exec(b);return d?d[2]?decodeURIComponent(d[2].replace(/\+/g," ")):"":null};const form=document.forms["comment-form"],formButton=document.getElementById("form-button"),nameInput=document.getElementById("userName"),ratingInput=document.getElementById("rating"),commentInput=document.getElementById("comment"),INPUTS=[{name:"nameInput",el:nameInput,error:"name"},{name:"ratingInput",el:ratingInput,error:"rating"},{name:"commentInput",el:commentInput,error:"comment"}],createComment=a=>{const b=self.restaurant;a.createdAt=Date.now(),a.updatedAt=Date.now(),b.reviews.push(a),saveRestaurantInIndexedDb(b,getParameterByName("id")).then(()=>{const b=document.getElementById("reviews-list");b.appendChild(createReviewHTML(a)),b.lastChild.scrollIntoView({behavior:"smooth"}),form.userName.value="",form.rating.value="",form.comment.value=""}),"serviceWorker"in navigator&&"SyncManager"in window&&navigator.serviceWorker.ready.then(b=>{dbPromise.then(b=>{const c=b.transaction("sync-reviews","readwrite"),d=c.objectStore("sync-reviews");return d.put(a,`sync-review`),c.complete}).then(()=>{navigator.isOnline||document.getElementById("offline-error").classList.add("error-msg--is-visible"),b.sync.register("sync-new-reviews")})})},showError=a=>{document.getElementById(`error-${a}`).classList.add("error-msg--is-visible")},hideError=a=>{document.getElementById(`error-${a}`).classList.remove("error-msg--is-visible")},validateInput=(a,b)=>(!a||3>a.length)&&(showError(b),!0),validateRating=a=>!a&&(showError("rating"),!0),validator={nameInput:a=>validateInput(a,"name"),commentInput:a=>validateInput(a,"comment"),ratingInput:()=>validateRating(form.rating.value)};INPUTS.forEach(a=>{a.el.addEventListener("blur",()=>validator[a.name](event.target.value)),a.el.addEventListener("focus",()=>{hideError(a.error),hideError("form")})}),formButton.addEventListener("click",a=>{a.preventDefault();const b=+getParameterByName("id"),c={name:form.userName.value,rating:form.rating.value,comments:form.comment.value,restaurant_id:b},d=[];validator.nameInput(c.name)&&d.push("name"),validator.commentInput(c.comments)&&d.push("comments"),validator.ratingInput()&&d.push("rating");const e=0<d.length;return e?void showError("form"):void createComment(c)}),document.getElementById("add-new-review").addEventListener("click",()=>{document.getElementById("form").scrollIntoView({behavior:"smooth"})});